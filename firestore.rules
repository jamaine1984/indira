rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Is the user logged in?
    function isAuth() {
      return request.auth != null;
    }

    // Helper: Check if request is from the owner of the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Helper: String length validator
    function validString(txt, max) {
      return txt is string && txt.size() > 0 && txt.size() <= max;
    }

    // ============================================================
    // USERS COLLECTION
    // ============================================================

    match /users/{userId} {

      // All logged-in users can READ and LIST all profiles (required for Discover)
      // 'read' = single document reads, 'list' = query operations
      allow read, list: if isAuth();

      // Only owner can create/update their profile
      allow create, update: if isOwner(userId);

      // Never allow delete
      allow delete: if false;

      // Usage subcollection (daily usage tracking)
      match /usage/{usageId} {
        // Owner can read and write their own usage data
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================================
    // LIKES COLLECTION
    // ============================================================

    match /likes/{likeId} {
      // Allow all operations for authenticated users
      allow read, write: if isAuth();
    }

    // ============================================================
    // SWIPES COLLECTION
    // ============================================================

    match /swipes/{swipeId} {
      // Allow all operations for authenticated users
      allow read, write: if isAuth();
    }

    // ============================================================
    // MATCHES COLLECTION
    // ============================================================

    match /matches/{matchId} {
      // Allow all operations for authenticated users
      allow read, write: if isAuth();
    }

    // ============================================================
    // MESSAGES SUBCOLLECTION (messages inside matches)
    // ============================================================

    match /matches/{matchId}/messages/{messageId} {

      // Only allow messages between matched users
      allow read, list: if isAuth() &&
                  (request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users);

      allow create: if isAuth() &&
                    request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users &&
                    validString(request.resource.data.content, 2000);

      // Allow updating delivery/read timestamps only
      allow update: if isAuth() &&
                    request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users &&
                    request.resource.data.diff(resource.data).changedKeys().hasOnly(["readAt", "deliveredAt"]);

      allow delete: if false;
    }

    // ============================================================
    // CHATS COLLECTION (main chat documents)
    // ============================================================

    match /chats/{chatId} {

      // Allow authenticated users to read and list chats they're part of
      allow read, list: if isAuth();

      // Allow creating and updating chats
      allow create, update: if isAuth();

      // Don't allow deleting chats
      allow delete: if false;

      // Messages subcollection within chats
      match /messages/{messageId} {

        // Allow authenticated users to read and list messages
        allow read, list: if isAuth();

        // Allow creating messages
        allow create: if isAuth();

        // Allow updating message status (read, delivered)
        allow update: if isAuth();

        // Don't allow deleting messages
        allow delete: if false;
      }
    }

    // ============================================================
    // USER GIFTS
    // ============================================================

    match /user_gifts/{giftId} {

      // 'read' = single document reads, 'list' = query operations
      allow read, list: if isAuth();

      allow create: if isAuth() &&
                     (request.resource.data.senderId == request.auth.uid ||
                      request.resource.data.receiverId == request.auth.uid);

      allow update: if isAuth() &&
                    (resource.data.receiverId == request.auth.uid ||
                     resource.data.senderId == request.auth.uid);

      allow delete: if false;
    }

    // ============================================================
    // REPORTS COLLECTION
    // ============================================================

    match /reports/{reportId} {

      allow create: if isAuth() &&
                     request.resource.data.reporterId == request.auth.uid &&
                     validString(request.resource.data.reason, 500);

      allow read: if false; // Only admins should read (handled server-side)
      allow update, delete: if false;
    }

    // ============================================================
    // BLOCKED USERS
    // ============================================================

    match /blocked_users/{blockId} {

      allow create: if isAuth() &&
                     request.resource.data.blockerId == request.auth.uid;

      // 'read' = single document reads
      allow read: if isAuth() &&
                  (resource.data.blockerId == request.auth.uid);

      // 'list' = query operations - allow all authenticated users
      // (query filter handles showing only relevant blocks)
      allow list: if isAuth();

      allow delete: if isAuth() &&
                     resource.data.blockerId == request.auth.uid;

      allow update: if false;
    }

    // ============================================================
    // BOOSTS COLLECTION
    // ============================================================

    match /boosts/{boostId} {

      allow read: if isAuth();
      allow list: if isAuth();

      allow create: if isAuth() &&
                     request.resource.data.userId == request.auth.uid;

      allow update: if false;
      allow delete: if false;
    }

    // ============================================================
    // NOTIFICATIONS
    // ============================================================

    match /notifications/{notificationId} {

      allow read: if isAuth() &&
                  (resource.data.userId == request.auth.uid ||
                   resource.data.recipientId == request.auth.uid);

      allow create: if isAuth() &&
                     (request.resource.data.userId == request.auth.uid ||
                      request.resource.data.recipientId == request.auth.uid);

      allow update: if isAuth() &&
                    (request.auth.uid == resource.data.userId ||
                     request.auth.uid == resource.data.recipientId);

      allow delete: if false;
    }

    // ============================================================
    // PURCHASES (IAP)
    // ============================================================

    match /purchases/{purchaseId} {
      allow create: if isAuth() &&
                     request.resource.data.userId == request.auth.uid;

      allow read: if isAuth() &&
                  resource.data.userId == request.auth.uid;

      allow update, delete: if false;
    }

    // ============================================================
    // CONFIG — PUBLIC READ
    // ============================================================

    match /config/{configId} {
      allow read: if true;
      allow write: if false;
    }

    // ============================================================
    // LEGAL — PUBLIC READ
    // ============================================================

    match /legal/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // ============================================================
    // ANALYTICS — USER ACTION LOGGING
    // ============================================================

    match /analytics/{analyticsId} {
      // Allow all operations for authenticated users
      allow read, write: if isAuth();
    }

    // ============================================================
    // SOCIAL POSTS — LOVERS ANONYMOUS
    // ============================================================

    match /social_posts/{postId} {
      // Allow all authenticated users to read and list posts
      allow read, list: if isAuth();

      // Allow creating posts
      allow create: if isAuth() &&
                     request.resource.data.userId == request.auth.uid;

      // Allow updating posts (for likes)
      allow update: if isAuth();

      // Allow deleting own posts
      allow delete: if isAuth() &&
                     resource.data.userId == request.auth.uid;
    }
  }
}
