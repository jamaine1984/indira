rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isOwnerOrAdmin(userId) {
      return isOwner(userId) || request.auth.token.admin == true;
    }

    function isValidUser() {
      return isAuthenticated() &&
             request.auth.token.email_verified == true;
    }

    // Users collection
    match /users/{userId} {
      // Allow read/write for the user themselves
      allow read, write: if isOwner(userId);

      // Allow read for all authenticated users (for profiles, social, discover)
      allow read: if isAuthenticated();

      // Allow update for profile completion and basic updates
      allow update: if isOwner(userId) &&
                       request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['displayName', 'age', 'gender', 'location', 'bio',
                                'interests', 'languages', 'photos', 'profileComplete',
                                'isOnline', 'lastSeen', 'settings', 'subscriptionTier',
                                'subscriptionExpiry', 'isBoosted', 'boostEndTime']);

      // Usage subcollection for tracking daily limits
      match /usage/{dateKey} {
        allow read, write: if isOwner(userId);
      }
    }

    // Likes collection
    match /likes/{likeId} {
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.likerId ||
                      request.auth.uid == resource.data.likedUserId);
      allow create: if isAuthenticated() &&
                       request.resource.data.likerId == request.auth.uid;
      allow update: if isAuthenticated() &&
                       (request.auth.uid == resource.data.likerId ||
                        request.auth.uid == resource.data.likedUserId);
      allow delete: if isAuthenticated() &&
                       request.auth.uid == resource.data.likerId;
    }

    // Boosts collection
    match /boosts/{boostId} {
      allow read: if isAuthenticated() &&
                     request.auth.uid == resource.data.userId;
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() &&
                       request.auth.uid == resource.data.userId;
      allow delete: if isAuthenticated() &&
                       request.auth.uid == resource.data.userId;
    }

    // Swipes collection (for tracking all swipes including passes)
    match /swipes/{swipeId} {
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      allow write: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
    }

    // Matches collection
    match /matches/{matchId} {
      allow read: if isAuthenticated() &&
                     request.auth.uid in resource.data.users;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
                       request.auth.uid in resource.data.users;

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
                       request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users;
        allow create: if isAuthenticated() &&
                         request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users &&
                         request.resource.data.senderId == request.auth.uid;
        allow update: if isAuthenticated() &&
                         request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users;
      }
    }

    // Messages collection (legacy)
    match /chats/{chatId} {
      // Allow read/write if user is part of the chat
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/matches/$(chatId)) &&
                            request.auth.uid in get(/databases/$(database)/documents/matches/$(chatId)).data.users;
    }

    match /chats/{chatId}/messages/{messageId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/matches/$(chatId)) &&
                            request.auth.uid in get(/databases/$(database)/documents/matches/$(chatId)).data.users;
    }

    // Social Feed (Posts)
    match /posts/{postId} {
      allow read: if isValidUser();
      allow create: if isValidUser() &&
                       request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Social Posts collection
    match /social_posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() &&
                       request.auth.uid == resource.data.userId;
    }

    // Post likes
    match /post_likes/{likeId} {
      allow read: if isValidUser();
      allow write: if isAuthenticated() &&
                      request.auth.uid == resource.data.userId;
    }

    // Post comments
    match /post_comments/{commentId} {
      allow read: if isValidUser();
      allow write: if isAuthenticated() &&
                      request.auth.uid == resource.data.userId;
    }

    // Gifts collection
    match /gifts/{giftId} {
      allow read: if isValidUser();
    }

    // User gifts (sent gifts)
    match /user_gifts/{giftId} {
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.senderId ||
                      request.auth.uid == resource.data.receiverId);
      allow create: if isAuthenticated() &&
                       request.auth.uid == resource.data.senderId;
      allow update: if isAuthenticated() &&
                       request.auth.uid == resource.data.receiverId;
    }

    // Video calls
    match /video_calls/{callId} {
      allow read, write: if isAuthenticated() &&
                            (request.auth.uid == resource.data.callerId ||
                             request.auth.uid == resource.data.calleeId);
    }

    // Notifications
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated() &&
                            request.auth.uid == resource.data.userId;
    }

    // Analytics (for internal use)
    match /analytics/{analyticId} {
      allow write: if isAuthenticated();
      allow read: if request.auth.token.admin == true;
    }

    // Reports collection
    match /reports/{reportId} {
      // Users can create reports and read their own reports
      allow create: if isAuthenticated() &&
                       request.resource.data.reporterId == request.auth.uid;
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.reporterId ||
                      request.auth.token.admin == true);
      // Only admins can update report status
      allow update: if request.auth.token.admin == true;
      allow delete: if request.auth.token.admin == true;
    }

    // Blocked users collection
    match /blocked_users/{blockId} {
      // Users can block/unblock and see their blocked list
      allow create: if isAuthenticated() &&
                       request.resource.data.blockerId == request.auth.uid;
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.blockerId ||
                      request.auth.uid == resource.data.blockedUserId);
      allow delete: if isAuthenticated() &&
                       request.auth.uid == resource.data.blockerId;
    }

    // Purchases collection (for IAP tracking)
    match /purchases/{purchaseId} {
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() &&
                     request.auth.uid == resource.data.userId;
      // Only admins can update/delete purchases
      allow update, delete: if request.auth.token.admin == true;
    }
  }
}
