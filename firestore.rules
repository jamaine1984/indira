rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Is the user logged in?
    function isAuth() {
      return request.auth != null;
    }

    // Helper: Check if request is from the owner of the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Helper: String length validator
    function validString(txt, max) {
      return txt is string && txt.size() > 0 && txt.size() <= max;
    }

    // ============================================================
    // USERS COLLECTION
    // ============================================================

    match /users/{userId} {

      // All logged-in users can READ single profiles (required for Discover)
      allow read: if isAuth();

      // COST OPTIMIZATION: Limit bulk queries to prevent expensive reads
      // At 1M users, unlimited queries would cost $0.60 per 1000 reads
      // This limit forces client-side caching (95%+ cost reduction)
      allow list: if isAuth() && request.query.limit <= 100;

      // Only owner can create/update their profile
      allow create, update: if isOwner(userId);

      // Never allow delete
      allow delete: if false;

      // Usage subcollection (daily usage tracking)
      match /usage/{usageId} {
        // Owner can read and write their own usage data
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================================
    // LIKES COLLECTION
    // ============================================================

    match /likes/{likeId} {
      // Allow reading individual likes
      allow read: if isAuth();

      // COST OPTIMIZATION: Limit queries to prevent expensive scans
      allow list: if isAuth();

      // Allow creating likes - check likerId field (who is sending the like)
      allow create: if isAuth() && isOwner(request.resource.data.likerId);

      // Allow updating likes (for mutual match status)
      allow update: if isAuth() &&
        (isOwner(resource.data.likerId) || isOwner(resource.data.likedUserId));

      // Allow deleting own likes
      allow delete: if isAuth() && isOwner(resource.data.likerId);
    }

    // ============================================================
    // SWIPES COLLECTION
    // ============================================================

    match /swipes/{swipeId} {
      // Allow reading individual swipes
      allow read: if isAuth();

      // COST OPTIMIZATION: Limit queries (swipes are logged for analytics)
      allow list: if isAuth() && request.query.limit <= 100;

      // Allow creating swipes
      allow create: if isAuth() && isOwner(request.resource.data.userId);

      // Swipes are immutable once created
      allow update, delete: if false;
    }

    // ============================================================
    // MATCHES COLLECTION
    // ============================================================

    match /matches/{matchId} {
      // Allow reading individual matches
      allow read: if isAuth();

      // COST OPTIMIZATION: Limit match queries
      // Users typically have 10-100 matches, limit to 200 for safety
      allow list: if isAuth() && request.query.limit <= 200;

      // Allow creating matches (from Cloud Functions or mutual likes)
      allow create: if isAuth();

      // Allow updating match metadata (lastMessage, etc.)
      allow update: if isAuth();

      // Don't allow deleting matches (archive instead)
      allow delete: if false;
    }

    // ============================================================
    // MESSAGES SUBCOLLECTION (messages inside matches)
    // ============================================================

    match /matches/{matchId}/messages/{messageId} {

      // Only allow reading individual messages between matched users
      allow read: if isAuth() &&
                  (request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users);

      // COST OPTIMIZATION: Limit message queries per conversation
      // Most conversations show last 50-100 messages, limit to 200
      allow list: if isAuth() &&
                  (request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users) &&
                  request.query.limit <= 200;

      // Allow creating messages with size validation
      allow create: if isAuth() &&
                    request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users &&
                    validString(request.resource.data.text, 2000);

      // Allow updating delivery/read timestamps only
      allow update: if isAuth() &&
                    request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users &&
                    request.resource.data.diff(resource.data).changedKeys().hasOnly(["readAt", "deliveredAt", "read"]);

      // Don't allow deleting messages
      allow delete: if false;
    }

    // ============================================================
    // CHATS COLLECTION (main chat documents)
    // ============================================================

    match /chats/{chatId} {

      // Allow authenticated users to read and list chats they're part of
      allow read, list: if isAuth();

      // Allow creating and updating chats
      allow create, update: if isAuth();

      // Don't allow deleting chats
      allow delete: if false;

      // Messages subcollection within chats
      match /messages/{messageId} {

        // Allow authenticated users to read and list messages
        allow read, list: if isAuth();

        // Allow creating messages
        allow create: if isAuth();

        // Allow updating message status (read, delivered)
        allow update: if isAuth();

        // Don't allow deleting messages
        allow delete: if false;
      }
    }

    // ============================================================
    // USER GIFTS (Inventory - gifts owned by user)
    // ============================================================

    match /user_gifts/{giftId} {

      // 'read' = single document reads, 'list' = query operations
      allow read, list: if isAuth();

      // Allow users to add gifts to their own inventory (from ads, subscriptions, etc.)
      // Also allow gifts with senderId/receiverId (sent between users)
      allow create: if isAuth() &&
                     (request.resource.data.userId == request.auth.uid ||
                      request.resource.data.senderId == request.auth.uid ||
                      request.resource.data.receiverId == request.auth.uid);

      // Allow users to update their own gifts
      allow update: if isAuth() &&
                    (resource.data.userId == request.auth.uid ||
                     resource.data.receiverId == request.auth.uid ||
                     resource.data.senderId == request.auth.uid);

      allow delete: if false;
    }

    // ============================================================
    // REPORTS COLLECTION
    // ============================================================

    match /reports/{reportId} {

      allow create: if isAuth() &&
                     request.resource.data.reporterId == request.auth.uid &&
                     validString(request.resource.data.reason, 500);

      allow read: if false; // Only admins should read (handled server-side)
      allow update, delete: if false;
    }

    // ============================================================
    // BLOCKED USERS
    // ============================================================

    match /blocked_users/{blockId} {

      allow create: if isAuth() &&
                     request.resource.data.blockerId == request.auth.uid;

      // 'read' = single document reads
      allow read: if isAuth() &&
                  (resource.data.blockerId == request.auth.uid);

      // 'list' = query operations - allow all authenticated users
      // (query filter handles showing only relevant blocks)
      allow list: if isAuth();

      allow delete: if isAuth() &&
                     resource.data.blockerId == request.auth.uid;

      allow update: if false;
    }

    // ============================================================
    // BOOSTS COLLECTION
    // ============================================================

    match /boosts/{boostId} {

      allow read: if isAuth();
      allow list: if isAuth();

      allow create: if isAuth() &&
                     request.resource.data.userId == request.auth.uid;

      allow update: if false;
      allow delete: if false;
    }

    // ============================================================
    // NOTIFICATIONS
    // ============================================================

    match /notifications/{notificationId} {

      allow read: if isAuth() &&
                  (resource.data.userId == request.auth.uid ||
                   resource.data.recipientId == request.auth.uid);

      allow create: if isAuth() &&
                     (request.resource.data.userId == request.auth.uid ||
                      request.resource.data.recipientId == request.auth.uid);

      allow update: if isAuth() &&
                    (request.auth.uid == resource.data.userId ||
                     request.auth.uid == resource.data.recipientId);

      allow delete: if false;
    }

    // ============================================================
    // PURCHASES (IAP)
    // ============================================================

    match /purchases/{purchaseId} {
      allow create: if isAuth() &&
                     request.resource.data.userId == request.auth.uid;

      allow read: if isAuth() &&
                  resource.data.userId == request.auth.uid;

      allow update, delete: if false;
    }

    // ============================================================
    // CONFIG — PUBLIC READ
    // ============================================================

    match /config/{configId} {
      allow read: if true;
      allow write: if false;
    }

    // ============================================================
    // LEGAL — PUBLIC READ
    // ============================================================

    match /legal/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // ============================================================
    // ANALYTICS — USER ACTION LOGGING
    // ============================================================

    match /analytics/{analyticsId} {
      // Allow all operations for authenticated users
      allow read, write: if isAuth();
    }

    // ============================================================
    // SOCIAL POSTS — LOVERS ANONYMOUS
    // ============================================================

    match /social_posts/{postId} {
      // Allow all authenticated users to read and list posts
      allow read, list: if isAuth();

      // Allow creating posts
      allow create: if isAuth() &&
                     request.resource.data.userId == request.auth.uid;

      // Allow updating posts (for likes)
      allow update: if isAuth();

      // Allow deleting own posts
      allow delete: if isAuth() &&
                     resource.data.userId == request.auth.uid;

      // Comments subcollection
      match /comments/{commentId} {
        allow read, list: if isAuth();
        allow create: if isAuth() &&
                       request.resource.data.userId == request.auth.uid;
        allow delete: if isAuth() &&
                       resource.data.userId == request.auth.uid;
        allow update: if false;
      }
    }

    // ============================================================
    // RATE LIMITS — ANTI-ABUSE
    // ============================================================

    match /rate_limits/{limitId} {
      // Allow users to read and write their own rate limit data
      allow read, write: if isAuth() &&
                          limitId.matches(request.auth.uid + '_.*');
    }

    // ============================================================
    // ACTION LOGS — USER ACTIVITY TRACKING
    // ============================================================

    match /action_logs/{logId} {
      // Allow users to read and write their own action logs
      allow read, write: if isAuth();
    }
  }
}
